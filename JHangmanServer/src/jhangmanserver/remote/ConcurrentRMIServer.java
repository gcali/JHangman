package jhangmanserver.remote;

import java.rmi.AlreadyBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.UnicastRemoteObject;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.atomic.AtomicInteger;

import jhangmanserver.users.User;
import rmi_interface.ClientCallbackRMI;
import rmi_interface.RMIServer;
import rmi_interface.UserAlreadyLoggedInException;
import rmi_interface.UserAlreadyRegisteredException;
import rmi_interface.UserNotLoggedInException;
import rmi_interface.WrongPasswordException;

public class ConcurrentRMIServer implements RMIServer {
//  Questa Ã¨ la mia riga TODO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `   `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       q                                                                                                                                                                                                                                                                                                           q                                                                                                                                                                                                                                                                                       q                                                                                                                                                                                                                                                       q                                                                                                                                                                                                                                                                               q                                                                                                                                                                                                                                                                                                   qpuzzi      `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   2``````````````````````````````````````````````````````````                                                                                                                                                                                                                                                                                                                                 w                                                                                                                                                                                                                                                                                                                                                                                                                                       q                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   wq                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              w                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       `                                                                                                                       ``````````````````````````````````````````````````````````````````````````````````````````````````````````````````                                                                                                                                                                                                                                                                                                                                  `````````````````````````````````````````````````````````````````````````                                                                                                                                                                                                                                                                                        
    private Map<String,User> userData = new HashMap<String, User>(); 
	private Registry registry = null;
	private static AtomicInteger cookies = new AtomicInteger();

    public void export(String bindingName, int port) throws RemoteException {
        if (this.registry == null) {
                this.registry = LocateRegistry.createRegistry(port);
        }
        RMIServer stub = (RMIServer) UnicastRemoteObject.exportObject(this, port);
        System.out.println("Stub exported");
        try {
            System.out.println("Binding...");
            this.registry.bind(bindingName, stub);
            System.out.println("Bound!");
        } catch (AlreadyBoundException e) { 
            System.out.println("Stub was already bound");
            this.registry.rebind(bindingName, stub);
        }
    }

    @Override
    public int logIn(String nick, String password, ClientCallbackRMI notifier)
            throws WrongPasswordException, RemoteException, UserAlreadyLoggedInException {
        User user = getUser(nick);
        if (user == null) {
            throw new WrongPasswordException("User data incorrect");
        }
        int cookie;
        synchronized(user) {
            if (!user.isPasswordCorrect(password)) {
                throw new WrongPasswordException("User data incorrect");
            } else if (user.isLoggedIn()) {
                throw new UserAlreadyLoggedInException();
            }
            cookie = cookies.getAndIncrement();
            user.setCookie(cookie);
            user.setCallback(notifier);
            user.setLoggedIn(true);
        }
        return cookie;
    }
    
    public int forceLogIn(String nick, 
                           String password, 
                           ClientCallbackRMI notifier)
                                   throws WrongPasswordException, RemoteException { 
        User user = getUser(nick);
        if (user == null) { 
            throw new WrongPasswordException("User data incorrect");
        }
        basicUserLogOut(user);
        try {
            return logIn(nick, password, notifier);
        } catch (UserAlreadyLoggedInException e) {
            return forceLogIn(nick, password, notifier);
        }
    }

    private void basicUserLogOut(User user) {
        synchronized(user) {
            user.removeCallback();
            user.setLoggedIn(false); 
        }
    }
    
    private User getUser(String nick) {
        User user = null;
        synchronized(this.userData) {
            user = this.userData.get(nick);
        }
        return user;
    }
    @Override
    public void logOut(String nick, int cookie) throws UserNotLoggedInException,
            RemoteException {
        User user = getUser(nick);

        if (user == null) {
            throw new UserNotLoggedInException();
        }

        synchronized(user) {
            if (user.isLoggedIn() && user.checkCookie(cookie)) {
                basicUserLogOut(user);
            } else {
                throw new UserNotLoggedInException();
            }
        } 
    }

    @Override
    public void register(String nick, String password)
            throws UserAlreadyRegisteredException, RemoteException {
        synchronized(this.userData) {
            if (this.userData.containsKey(nick)) {
                throw new UserAlreadyRegisteredException(nick);
            }
            User user = new User(nick, password);
            this.userData.put(nick, user);
        }
    }

}